-- modules/vm.lua
-- Virtual Machine template generator

local VM = {}

function VM.getTemplate()
    return "local v0=tonumber;local v1=string.byte;local v2=string.char;local v3=string.sub;local v4=string.gsub;local v5=string.rep;local v6=table.concat;local v7=table.insert;local v8=math.ldexp;local v9=getfenv or function()return _ENV;end;local v10=setmetatable;local v11=pcall;local v12=select;local v13=unpack or table.unpack;local v14=tonumber;local function v15(v16,v17,...)local v18=1;local v19;v16=v4(v3(v16,5),\"..\",function(v30)if(v1(v30,2)==79)then v19=v0(v3(v30,1,1));return \"\";else local v84=v2(v0(v30,16));if v19 then local v100=v5(v84,v19);v19=nil;return v100;else return v84;end end end);local function v20(v31,v32,v33)if v33 then local v85=(v31/((5-3)^(v32-(2-1))))%((3-1)^(((v33-(2-1))-(v32-(2-1)))+(2-1)));return v85-(v85%(932-(857+74)));else local v86=(569-(367+201))^(v32-((1131-(87+968))-((240-153)+2)));return(((v31%(v86+v86))>=v86)and(928-(214+713)))or(0+0);end end local function v21()local v34=v1(v16,v18,v18);v18=v18+1;return v34;end local function v22()local v35,v36=v1(v16,v18,v18+2-1);v18=v18+(5-3);return(v36*(1526-(226+1044)))+v35;end local function v23()local v37,v38,v39,v40=v1(v16,v18,v18+3);v18=v18+(1274-(297+973));return(v40*(16778981-(209+556)))+(v39*((192240-126704)))+(v38*(472-216))+v37;end local function v24()local v41=v23();local v42=v23();local v43=4-3;local v44=(v20(v42,2-1,979-(553+399))*(((6-4)+0)^(8+24)))+v41;local v45=v20(v42,38-17,1068-(745+292));local v46=((v20(v42,44-12)==(1-0))and -(1-0))or(1+0+0);if(v45==(1187-(1069+118)))then if(v44==(997-(915+82)))then return v46*(0-0);else v45=1-0;v43=0-0;end elseif(v45==(4260-2213))then return((v44==(0-0))and(v46*((1414-(447+966))/((791-556)-((1409-1158)+143)))))or(v46*NaN);end return v8(v46,v45-((3286-2426)-((2148-(1523+114))+320)))*(v43+(v44/((793-(368+423))^((196-104)-40))));end local function v25(v47)local v48;if not v47 then v47=v23();if(v47==(0+0))then return \"\";end end;v48=v3(v16,v18,(v18+v47)-1);v18=v18+v47;local v49={};for v67=3-2,#v48 do v49[v67]=v2(v1(v3(v48,v67,v67)));end return v6(v49);end local v26=v23;local function v27(...)return{...},v12(\"#\",...);end local function v28()local v50={};local v51={};local v52={};local v53={v50,v51,nil,v52};local v54=v23();local v55={};for v68=2-1,v54 do local v69=v21();local v70;if(v69==(1818-(1703+114)))then v70=(v21()~=(0-0));elseif(v69==(755-(239+514)))then v70=v24();elseif(v69==3)then v70=v25();end v55[v68]=v70;end;v53[1828-(1195+630)]=v21();for v71=1,v23()do local v72=v21();if(v20(v72,1-0,305-(244+60))==(0+0))then local v87=v20(v72,2+0,613-(602+8));local v88=v20(v72,339-(118+217),1861-(673+1182));local v89={v22(),v22(),nil,nil};if(v87==(0-0))then v89[9-6]=v22();v89[4+0]=v22();elseif(v87==(1975-(1913+61)))then v89[3+0]=v23();elseif(v87==(2+0))then v89[858-(564+291)]=v23()-(2^16);elseif(v87==(3+0))then v89[3]=v23()-(2^(58-42));v89[7-3]=v22();end;if(v20(v88,2-1,2-1)==(1-0))then v89[7-5]=v55[v89[2-0]];end if(v20(v88,1818-(580+1236),2+0)==(2-1))then v89[8-5]=v55[v89[8-5]];end if(v20(v88,3+0,3+0)==(414-(15+398)))then v89[4]=v55[v89[4]];end v50[v71]=v89;end end;for v73=1+0,v23()do v51[v73-(2-1)]=v28();end;return v53;end local function v29(v56,v57,v58)local v59=v56[1+0];local v60=v56[2];local v61=v56[3+0];return function(...)local v74=v59;local v75=v60;local v76=v61;local v77=v27;local v78=1692-(1121+570);local v79=-(1+0);local v80={};local v81={...};local v82=v12(\"#\",...)-1;local v83={};local v84={};for v91=0,v82 do if(v91>=v76)then v80[v91-v76]=v81[v91+1];else v84[v91]=v81[v91+1+0];end end;local v85=(v82-v76)+1+0;local v86;local v87;while true do v86=v74[v78];v87=v86[1];if(v87<=18)then if(v87<=8)then if(v87<=3)then if(v87<=1)then if(v87>(65-65))then v84[v86[1+1]]=v84[v86[3]][v86[4+0]];else do return;end end elseif(v87<=(6-4))then v84[v86[2]]=v86[3];elseif(v87>(5-2))then local v121=v86[2];v84[v121]=v84[v121](v13(v84,v121+1,v79));else v84[v86[2+0]]=v58[v86[3]];end elseif(v87<=5)then if(v87>(11-7))then local v123=v86[1+1];local v124,v125=v77(v84[v123](v13(v84,v123+1+0,v86[3])));v79=(v125+v123)-1;local v126=1227-(322+905);for v163=v123,v79 do v126=v126+1;v84[v163]=v124[v126];end;else v84[v86[612-(602+8)]]=v29(v75[v86[3+0]],nil,v58);end elseif(v87<=6)then v84[v86[1+1]]=v84[v86[1496-(711+782)]];elseif(v87>7)then v84[v86[2]]=v86[6-3];else local v194=0;local v195;local v196;local v197;local v198;while true do if(v194==2)then for v260=v195,v79 do v198=v198+1+0;v84[v260]=v196[v198];end break;end if(v194==1)then v79=(v197+v195)-(837-(660+176));v198=0+0;v194=2;end if(v194==0)then v195=v86[4-2];v196,v197=v77(v84[v195](v84[v195+(1203-(1045+157))]));v194=1;end end end elseif(v87<=13)then if(v87<=10)then if(v87>9)then v84[v86[2]][v86[3]]=v84[v86[4]];else v84[v86[2+0]]=v58[v86[9-6]];end elseif(v87<=11)then local v130=v86[2];v84[v130](v84[v130+(1126-(936+189))]);elseif(v87>(29-17))then v84[v86[605-(316+287)]]=v84[v86[734-(476+255)]];else local v202=v86[1907-(830+1075)];v84[v202]=v84[v202](v13(v84,v202+1+0,v79));end elseif(v87<=15)then if(v87==14)then local v132=v86[2];local v133={v84[v132](v84[v132+1+(1414-(797+616))])};local v134=0+0;for v166=v132,v86[584-(361+219)]do v134=v134+1;v84[v166]=v133[v134];end else v84[v86[1+1]][v86[3+0]]=v84[v86[4+0]];end elseif(v87<=16)then local v135=v86[2+0];do return v13(v84,v135,v79);end elseif(v87>(12+5))then local v205=v86[2];v84[v205](v13(v84,v205+1+0,v79));else local v207=0;local v208;while true do if(v207==(0+0))then v208=v86[1+1];v84[v208]=v84[v208](v13(v84,v208+1,v86[3]));break;end end end elseif(v87<=28)then if(v87<=23)then if(v87<=20)then if(v87==19)then local v136=v86[2];local v137=v84[v86[3]];v84[v136+1+0]=v137;v84[v136]=v137[v86[4+0]];else local v139=v86[2];local v140={v84[v139](v84[v139+1])};local v141=0+0;for v169=v139,v86[1+3]do v141=v141+1+0;v84[v169]=v140[v141];end end elseif(v87<=21)then v84[v86[5-3]]=v84[v86[3]][v86[4+0]];elseif(v87>22)then local v210=v86[1+1];local v211={v84[v210](v13(v84,v210+1,v86[1193-(449+741)]))};local v212=0+0;for v245=v210,v86[4+0]do v212=v212+1;v84[v245]=v211[v212];end else v84[v86[1+1]]=v29(v75[v86[3]],nil,v58);end elseif(v87<=25)then if(v87==24)then local v143=v86[1+1];do return v84[v143](v13(v84,v143+1,v86[3+0]));end else local v145=v86[1+1];local v146=v84[v145];for v172=v145+(2-1),v86[3+0]do v146=v146 .. v84[v172];end v84[v86[2]]=v146;end elseif(v87<=26)then do return;end elseif(v87>27)then local v214=v86[2+0];do return v13(v84,v214,v214+v86[3+0]);end else local v216=v86[2];local v217=v84[v86[3]];v84[v216+1]=v217;v84[v216]=v217[v86[1+3]];end elseif(v87<=33)then if(v87<=30)then if(v87==29)then local v147=v86[2];local v148,v149=v77(v84[v147](v13(v84,v147+1,v86[3])));v79=(v149+v147)-1+0;local v150=0+0;for v175=v147,v79 do v150=v150+1;v84[v175]=v148[v150];end;else local v152=v86[2+0];local v153={v84[v152](v13(v84,v152+1,v86[3+0]))};local v154=0+0;for v178=v152,v86[4]do v154=v154+1+0;v84[v178]=v153[v154];end end elseif(v87<=31)then v84[v86[2]][v86[3]]=v84[v86[1790-(573+1213)]];elseif(v87>32)then local v221=v86[2+0];local v222={v84[v221](v13(v84,v221+1+0,v86[3]))};local v223=0;for v248=v221,v86[4]do v223=v223+1;v84[v248]=v222[v223];end else local v225=v86[1+1];local v226=v84[v225];for v251=v225+1,v86[3]do v226=v226 .. v84[v251];end v84[v86[2+0]]=v226;end elseif(v87<=35)then if(v87>(27+7))then local v157=v86[2+0];do return v84[v157](v13(v84,v157+(1156-(1074+81)),v86[3]));end else local v159=v86[2];v84[v159](v13(v84,v159+(1-0),v79));end elseif(v87<=36)then v84[v86[3-1]]=v84[v86[3]][v86[4+0]];elseif(v87>(40-3))then local v229=v86[2];v84[v229](v84[v229+(237-(141+95))]);else local v231=v86[2];local v232={v84[v231](v84[v231+(1727-(1668+58))])};local v233=0;for v254=v231,v86[4]do v233=v233+1;v84[v254]=v232[v233];end end v78=v78+1+0;end end;end return v29(v28(),{},v17)(...);end"
end

function VM.wrapCode(encodedBytes)
    local template = VM.getTemplate()
    return string.format(
        "return(function(...) %s local v17=v2(%s); local v18=assert(loadstring or load); local v19=v18(v17); return v19(...); end)(...);",
        template,
        encodedBytes
    )
end

return VM
